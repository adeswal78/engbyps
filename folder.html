<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Course Folders & Files</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: linear-gradient(120deg, #00c3ff 0%, #ffff1c 100%);
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 2rem auto;
            background: rgba(255, 255, 255, 0.13);
            border-radius: 18px;
            box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.18);
            padding: 2rem 1rem;
        }
        
        h2 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(90deg, #00ffb8, #008cff, #ff00c8);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            font-weight: 700;
        }
        
        #folderList {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .folder-card {
            background: linear-gradient(90deg, #fffbe7 0%, #ffe0e6 100%);
            border-radius: 12px;
            padding: 0.7rem 1rem;
            box-shadow: 0 2px 12px 0 #d7263d22;
            border: 2px solid #ffb347;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            cursor: pointer;
            font-size: 1.08rem;
            font-weight: 600;
            color: #d7263d;
            min-height: 48px;
            transition: background 0.18s, transform 0.18s, border 0.18s;
        }
        
        .folder-card:hover {
            background: #ffb347;
            color: #fff;
            border-color: #d7263d;
            transform: scale(1.04);
        }
        
        .file-card {
            background: rgba(255, 255, 255, 0.10);
            border-radius: 10px;
            padding: 0.7rem 1rem;
            box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 0.7rem;
            cursor: pointer;
            font-size: 1.02rem;
            font-weight: 500;
            color: #d7263d;
            min-height: 48px;
            transition: background 0.18s, transform 0.18s;
        }
        
        .file-card:hover {
            background: #008cff;
            color: #fff;
            transform: scale(1.04);
        }
        
        .back-btn {
            margin-bottom: 1rem;
            background: #ff00c8;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1.2rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.18s;
        }
        
        .back-btn:hover {
            background: #008cff;
        }
        
        .folder-thumb {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: 7px;
            margin-right: 8px;
            background: #fff;
            border: 1.2px solid #d7263d33;
        }
        
        .thumb {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: 7px;
            margin-right: 8px;
            background: #fff;
            border: 1.2px solid #d7263d33;
        }
        
        .folder-arrow {
            margin-left: auto;
            width: 18px;
            height: 18px;
            display: inline-block;
            background: url('data:image/svg+xml;utf8,<svg fill=\"%23d7263d\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z\"/></svg>') no-repeat center center;
            background-size: 18px 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Course Folders & Files</h2>
        <button class="back-btn" id="backBtn" style="display:none">Back</button>
        <div id="folderList">Loading...</div>
    </div>

    <!-- CryptoJS (same as before) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script>
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        // Decrypt function (same as your Python/previous logic)
        function decryptCustom(enc) {
            if (!enc) return "";
            try {
                const b64 = enc.split(':')[0];
                const key = CryptoJS.enc.Utf8.parse('638udh3829162018');
                const iv = CryptoJS.enc.Utf8.parse('fedcba9876543210');
                const encrypted = CryptoJS.enc.Base64.parse(b64);
                const decrypted = CryptoJS.AES.decrypt({
                    ciphertext: encrypted
                }, key, {
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });
                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                return "";
            }
        }

        let historyStack = [];

        // ---------- UPDATED: use new API endpoint folder_contentsv3 ----------
        async function loadFolderContents(courseId, parentId = -1, pushHistory = true) {
            const folderList = document.getElementById('folderList');
            folderList.innerHTML = 'Loading...';
            try {
                // New API URL (as you provided)
                const url = `https://adeswal-eng.onrender.com/api/get/folder_contentsv3?course_id=${encodeURIComponent(courseId)}&parent_id=${encodeURIComponent(parentId)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();

                folderList.innerHTML = '';

                const items = Array.isArray(json.data) ? json.data : [];
                if (items.length === 0) {
                    folderList.textContent = 'No folders/files found.';
                    return;
                }

                items.forEach(item => {
                    // FOLDER detection (same checks as before)
                    if (
                        item.material_type === 'FOLDER' ||
                        item.type === 'FOLDER' ||
                        item.is_folder ||
                        item.folder_name ||
                        item.Title && item.material_type === 'FOLDER'
                    ) {
                        const card = document.createElement('div');
                        card.className = 'folder-card';

                        // Thumb
                        const thumb = document.createElement('img');
                        thumb.className = 'thumb';
                        thumb.src = item.thumbnail || 'https://cdn-icons-png.flaticon.com/512/3767/3767084.png';
                        thumb.onerror = function() { this.src = 'https://cdn-icons-png.flaticon.com/512/3767/3767084.png'; };
                        card.appendChild(thumb);

                        // Name
                        const name = document.createElement('span');
                        name.textContent = item.folder_name || item.name || item.Title || item.title || 'Folder';
                        card.appendChild(name);

                        // Arrow
                        const arrow = document.createElement('span');
                        arrow.className = 'folder-arrow';
                        card.appendChild(arrow);

                        card.onclick = function() {
                            if (pushHistory) historyStack.push({ courseId, parentId });
                            // drill into folder using item.id (or fallback parent_id)
                            loadFolderContents(courseId, item.id || item.parent_id || item.parent || -1);
                            document.getElementById('backBtn').style.display = 'inline-block';
                        };

                        folderList.appendChild(card);
                        return;
                    }

                    // PDF
                    if (item.material_type === 'PDF') {
                        const card = document.createElement('div');
                        card.className = 'file-card';

                        const thumb = document.createElement('img');
                        thumb.className = 'thumb';
                        thumb.src = item.thumbnail || 'https://cdn-icons-png.flaticon.com/512/337/337946.png';
                        thumb.onerror = function() { this.src = 'https://cdn-icons-png.flaticon.com/512/337/337946.png'; };
                        card.appendChild(thumb);

                        const name = document.createElement('span');
                        name.textContent = item.Title || item.title || item.name || 'PDF';
                        card.appendChild(name);

                        card.onclick = function() {
                            // The code keeps previous sentinel + decrypt behaviour
                            if (item.pdf_link === "6JaMPbY1Wn6AVb5u6uhyiBiomWEZo4qFvj6t7Um+HV4=:ZmVkY2JhOTg3NjU0MzIxMA==" ||
                                item.pdf_link2 === "6JaMPbY1Wn6AVb5u6uhyiBiomWEZo4qFvj6t7Um+HV4=:ZmVkY2JhOTg3NjU0MzIxMA==") {
                                showSadPopup("Sorry, we can't fetch your notes.");
                            } else if (item.pdf_link) {
                                const url = decryptCustom(item.pdf_link);
                                if (url) window.open(url, '_blank');
                                else showSadPopup("Sorry, we can't fetch your notes.");
                            } else if (item.pdf_link2) {
                                const url = decryptCustom(item.pdf_link2);
                                if (url) window.open(url, '_blank');
                                else showSadPopup("Sorry, we can't fetch your notes.");
                            } else {
                                showSadPopup("Sorry, we can't fetch your notes.");
                            }
                        };

                        folderList.appendChild(card);
                        return;
                    }

                    // IMAGE
                    if (item.material_type === 'IMAGE' || (item.thumbnail && String(item.thumbnail).toLowerCase().endsWith('.png'))) {
                        const card = document.createElement('div');
                        card.className = 'file-card';

                        const thumb = document.createElement('img');
                        thumb.className = 'thumb';
                        thumb.src = item.thumbnail ? item.thumbnail : 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                        thumb.onerror = function() { this.src = 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg'; };
                        card.appendChild(thumb);

                        const name = document.createElement('span');
                        name.textContent = item.Title || item.title || item.name || 'Image';
                        card.appendChild(name);

                        card.onclick = function() {
                            if (item.thumbnail) window.open(item.thumbnail, '_blank');
                        };

                        folderList.appendChild(card);
                        return;
                    }

                    // LINK
                    if (item.material_type === 'LINK' || item.file_link) {
                        const card = document.createElement('div');
                        card.className = 'file-card';

                        const thumb = document.createElement('img');
                        thumb.className = 'thumb';
                        thumb.src = item.thumbnail ? item.thumbnail : 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                        thumb.onerror = function() { this.src = 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg'; };
                        card.appendChild(thumb);

                        const name = document.createElement('span');
                        name.textContent = item.Title || item.title || item.name || 'Link';
                        card.appendChild(name);

                        card.onclick = function() {
                            if (item.file_link === "6JaMPbY1Wn6AVb5u6uhyiBiomWEZo4qFvj6t7Um+HV4=:ZmVkY2JhOTg3NjU0MzIxMA==") {
                                showSadPopup("Sorry, we can't fetch your notes.");
                            } else if (item.file_link) {
                                const url = decryptCustom(item.file_link);
                                if (url) window.open(url, '_blank');
                                else showSadPopup("Sorry, we can't fetch this link.");
                            }
                        };

                        folderList.appendChild(card);
                        return;
                    }

                    // VIDEO — UPDATED: always redirect to video-links.html with proper params
                    if (item.material_type === 'VIDEO' || item.video_id) {
                        const card = document.createElement('div');
                        card.className = 'file-card';

                        const thumb = document.createElement('img');
                        thumb.className = 'thumb';
                        thumb.src = item.thumbnail ? item.thumbnail : 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                        thumb.onerror = function() { this.src = 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg'; };
                        card.appendChild(thumb);

                        const name = document.createElement('span');
                        name.textContent = item.Title || item.title || item.name || 'Video';
                        card.appendChild(name);

                        card.onclick = function() {
                            // Build redirect URL to video-links.html (always)
                            const appId = getQueryParam("app_id") || "";
                            // Use item.id if present, else fall back to item.video_id
                            const vidParam = encodeURIComponent(item.id || item.video_id || "");
                            const ytflag = encodeURIComponent(item.ytFlagWeb ?? item.ytFlag ?? 0);
                            const courseParam = encodeURIComponent(courseId);
                            let redirectUrl = `video-links.html?courseId=${courseParam}&videoId=${vidParam}&ytflag=${ytflag}&folder_wise_course=1`;
                            if (appId) redirectUrl += `&app_id=${encodeURIComponent(appId)}`;
                            window.location.href = redirectUrl;
                        };

                        folderList.appendChild(card);
                        return;
                    }

                    // DEFAULT FILE
                    {
                        const card = document.createElement('div');
                        card.className = 'file-card';

                        const thumb = document.createElement('img');
                        thumb.className = 'thumb';
                        thumb.src = item.thumbnail ? item.thumbnail : 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                        thumb.onerror = function() { this.src = 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg'; };
                        card.appendChild(thumb);

                        const name = document.createElement('span');
                        name.textContent = item.Title || item.title || item.name || 'File';
                        card.appendChild(name);

                        card.onclick = function() {
                            if (item.file_url || item.file_link) {
                                // open direct link (if encrypted this won't decrypt unless item.file_link is encrypted and matches decrypt pattern)
                                const link = item.file_url || item.file_link;
                                // try decrypt, fallback to raw
                                const d = decryptCustom(link);
                                window.open(d || link, '_blank');
                            }
                        };

                        folderList.appendChild(card);
                    }
                });

            } catch (err) {
                console.error(err);
                folderList.innerHTML = 'Failed to load folders/files.';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // accept either 'courseid' or 'course_id' in query params
            const courseId = getQueryParam('courseid') || getQueryParam('course_id') || getQueryParam('courseId');
            if (!courseId) {
                document.getElementById('folderList').textContent = 'Course ID missing in URL.';
                return;
            }
            loadFolderContents(courseId, -1);

            document.getElementById('backBtn').onclick = function() {
                if (historyStack.length > 0) {
                    const prev = historyStack.pop();
                    loadFolderContents(prev.courseId, prev.parentId, false);
                    if (historyStack.length === 0) this.style.display = 'none';
                }
            };
        });

        // Sad popup (unchanged)
        function showSadPopup(msg) {
            let old = document.getElementById('sadPopupBg');
            if (old) old.remove();
            const popupBg = document.createElement('div');
            popupBg.id = 'sadPopupBg';
            popupBg.style.position = 'fixed';
            popupBg.style.top = 0;
            popupBg.style.left = 0;
            popupBg.style.right = 0;
            popupBg.style.bottom = 0;
            popupBg.style.background = 'rgba(0,0,0,0.45)';
            popupBg.style.zIndex = 9999;
            popupBg.style.display = 'flex';
            popupBg.style.alignItems = 'center';
            popupBg.style.justifyContent = 'center';

            const popup = document.createElement('div');
            popup.style.background = '#fffbe7';
            popup.style.borderRadius = '18px';
            popup.style.boxShadow = '0 8px 32px #d7263d44';
            popup.style.padding = '32px 28px 22px 28px';
            popup.style.minWidth = '320px';
            popup.style.maxWidth = '95vw';
            popup.style.border = '3px solid #d7263d';
            popup.style.position = 'relative';
            popup.style.textAlign = 'center';

            const sad = document.createElement('div');
            sad.className = 'sad-icon';
            sad.style.fontSize = '3rem';
            sad.style.marginBottom = '18px';
            sad.textContent = '😢';

            const txt = document.createElement('div');
            txt.className = 'sad-text';
            txt.style.fontSize = '1.15rem';
            txt.style.color = '#d7263d';
            txt.textContent = msg;

            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-sad-popup';
            closeBtn.textContent = '×';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '10px';
            closeBtn.style.right = '18px';
            closeBtn.style.background = '#d7263d';
            closeBtn.style.color = '#fff';
            closeBtn.style.border = 'none';
            closeBtn.style.borderRadius = '50%';
            closeBtn.style.width = '32px';
            closeBtn.style.height = '32px';
            closeBtn.style.fontSize = '1.2rem';
            closeBtn.style.cursor = 'pointer';
            closeBtn.onclick = function() {
                popupBg.remove();
            };

            popup.appendChild(closeBtn);
            popup.appendChild(sad);
            popup.appendChild(txt);
            popupBg.appendChild(popup);
            document.body.appendChild(popupBg);
        }
    </script>
</body>
</html>
