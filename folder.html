<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Course Folders & Files</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        :root{
            --accent-1:#00c3ff;
            --accent-2:#ffcc00;
            --card-bg: rgba(255,255,255,0.95);
            --muted:#6b7280;
            --danger:#d7263d;
        }
        html,body{height:100%;margin:0;font-family:'Segoe UI',Roboto,Arial,sans-serif;background:linear-gradient(120deg,var(--accent-1) 0%, #ffff1c 100%);}
        .wrap{max-width:1100px;margin:28px auto;padding:20px;}
        .top {
            display:flex;
            gap:12px;
            align-items:center;
            margin-bottom:18px;
        }
        .title {
            flex:1;
            font-size:20px;
            font-weight:700;
            background: linear-gradient(90deg,#00ffb8,#008cff,#ff00c8);
            -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
        }
        .back-btn {
            background: linear-gradient(90deg,#ff00c8,#008cff);
            color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;
            box-shadow:0 6px 18px rgba(0,0,0,0.12);
        }
        .breadcrumb {
            margin-top:8px;color:#111827;font-size:14px;
            display:flex;gap:8px;align-items:center;flex-wrap:wrap;
        }
        .badge {
            background:var(--card-bg);padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);
            box-shadow:0 4px 14px rgba(0,0,0,0.06);
        }

        .content {
            margin-top:18px;
            background: rgba(255,255,255,0.12);
            border-radius:14px;padding:18px;
            box-shadow:0 8px 32px rgba(31,38,135,0.06);
        }

        .grid {
            display:grid;
            grid-template-columns: repeat(auto-fill,minmax(260px,1fr));
            gap:16px;
        }

        /* folder card */
        .folder-card, .file-card {
            background:var(--card-bg);
            border-radius:12px;
            overflow:hidden;
            display:flex;
            gap:12px;
            align-items:center;
            padding:12px;
            border:1px solid rgba(0,0,0,0.06);
            cursor:pointer;
            transition: transform .16s ease, box-shadow .16s ease;
            min-height:84px;
        }
        .folder-card:hover, .file-card:hover { transform: translateY(-6px); box-shadow:0 16px 40px rgba(0,0,0,0.08); }

        .thumb-lg{
            width:120px;height:72px;object-fit:cover;border-radius:8px;background:#f3f4f6;border:1px solid rgba(0,0,0,0.04);
        }
        .thumb-sm{ width:56px;height:56px;object-fit:cover;border-radius:8px;background:#fff;border:1px solid rgba(0,0,0,0.06); }

        .meta {
            display:flex;flex-direction:column;gap:6px;flex:1;
        }
        .name { font-weight:700;color:#111827;font-size:15px; }
        .sub { color:var(--muted); font-size:13px; }

        .actions { display:flex; gap:8px; align-items:center; margin-left:auto; }
        .btn {
            padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600;
            background:#2563eb;color:#fff;display:inline-flex;align-items:center;gap:8px;
        }
        .btn.pdf { background:#f3f4f6;color:#111;border:1px solid rgba(0,0,0,0.06); }
        .small { font-size:12px;padding:6px 8px;border-radius:8px; }

        .empty {
            padding:36px;text-align:center;color:#fff;font-weight:700;
            text-shadow:0 2px 8px rgba(0,0,0,0.25);
        }

        @media(max-width:700px){
            .top{flex-direction:column;align-items:stretch;}
            .thumb-lg{width:110px;height:64px;}
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="top">
            <div class="title">üìÇ Course Folders & Files</div>
            <button id="backBtn" class="back-btn" style="display:none">‚Üê Back</button>
        </div>

        <div class="breadcrumb" id="breadcrumb">
            <div class="badge" id="crumbRoot">Home</div>
        </div>

        <div class="content">
            <div id="folderGrid" class="grid">
                Loading...
            </div>
            <div id="emptyMsg" class="empty" style="display:none">No folders/files found.</div>
        </div>
    </div>

    <!-- CryptoJS (existing decrypt) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <script>
        // Utility to read query params (support many names)
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        // Keep existing decryption logic unchanged (uses same key/iv as your code)
        function decryptCustom(enc) {
            if (!enc) return "";
            try {
                const b64 = enc.split(':')[0];
                const key = CryptoJS.enc.Utf8.parse('638udh3829162018');
                const iv = CryptoJS.enc.Utf8.parse('fedcba9876543210');
                const encrypted = CryptoJS.enc.Base64.parse(b64);
                const decrypted = CryptoJS.AES.decrypt({ ciphertext: encrypted }, key, {
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });
                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                return "";
            }
        }

        // history stack for breadcrumb/back navigation
        let historyStack = [];

        // current course & parent (kept global for callbacks)
        let currentCourseId = getQueryParam('courseid') || getQueryParam('course_id') || getQueryParam('courseId');
        if (!currentCourseId) {
            document.getElementById('folderGrid').innerHTML = '';
            document.getElementById('emptyMsg').style.display = 'block';
            document.getElementById('emptyMsg').textContent = 'Course ID missing in URL.';
        }

        let currentParent = getQueryParam('parentid') || getQueryParam('parent_id') || getQueryParam('parentId') || -1;

        // update breadcrumb UI
        function renderBreadcrumb() {
            const bc = document.getElementById('breadcrumb');
            bc.innerHTML = '';
            const root = document.createElement('div');
            root.className = 'badge';
            root.textContent = 'Home';
            root.onclick = () => {
                if (historyStack.length>0) {
                    // clear history and load root
                    historyStack = [];
                    loadFolderContents(currentCourseId, -1, false);
                    document.getElementById('backBtn').style.display = 'none';
                }
            };
            bc.appendChild(root);

            // show path labels from historyStack
            historyStack.forEach((h, idx) => {
                const sep = document.createElement('div'); sep.textContent = '‚Ä∫'; sep.style.margin='0 6px'; sep.style.color='rgba(0,0,0,0.35)';
                bc.appendChild(sep);
                const b = document.createElement('div');
                b.className = 'badge';
                b.textContent = h.label || `Folder ${h.parentId}`;
                b.onclick = () => {
                    // navigate to specific history index (pop until that index)
                    const target = historyStack[idx];
                    historyStack = historyStack.slice(0, idx+1);
                    loadFolderContents(currentCourseId, target.parentId, false);
                    document.getElementById('backBtn').style.display = historyStack.length ? 'inline-block' : 'none';
                };
                bc.appendChild(b);
            });

            // current folder name
            if (currentParent && String(currentParent) !== '-1') {
                const sep = document.createElement('div'); sep.textContent = '‚Ä∫'; sep.style.margin='0 6px'; sep.style.color='rgba(0,0,0,0.35)';
                bc.appendChild(sep);
                const cur = document.createElement('div');
                cur.className = 'badge';
                cur.textContent = `Folder ${currentParent}`;
                bc.appendChild(cur);
            }
        }

        // show sad popup (kept as before)
        function showSadPopup(msg) {
            let old = document.getElementById('sadPopupBg');
            if (old) old.remove();
            const popupBg = document.createElement('div');
            popupBg.id = 'sadPopupBg';
            popupBg.style.position = 'fixed';
            popupBg.style.top = 0;
            popupBg.style.left = 0;
            popupBg.style.right = 0;
            popupBg.style.bottom = 0;
            popupBg.style.background = 'rgba(0,0,0,0.45)';
            popupBg.style.zIndex = 9999;
            popupBg.style.display = 'flex';
            popupBg.style.alignItems = 'center';
            popupBg.style.justifyContent = 'center';

            const popup = document.createElement('div');
            popup.style.background = '#fffbe7';
            popup.style.borderRadius = '18px';
            popup.style.boxShadow = '0 8px 32px #d7263d44';
            popup.style.padding = '32px 28px 22px 28px';
            popup.style.minWidth = '320px';
            popup.style.maxWidth = '95vw';
            popup.style.border = '3px solid #d7263d';
            popup.style.position = 'relative';
            popup.style.textAlign = 'center';

            const sad = document.createElement('div');
            sad.className = 'sad-icon';
            sad.style.fontSize = '3rem';
            sad.style.marginBottom = '18px';
            sad.textContent = 'üò¢';

            const txt = document.createElement('div');
            txt.className = 'sad-text';
            txt.style.fontSize = '1.15rem';
            txt.style.color = '#d7263d';
            txt.textContent = msg;

            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-sad-popup';
            closeBtn.textContent = '√ó';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '10px';
            closeBtn.style.right = '18px';
            closeBtn.style.background = '#d7263d';
            closeBtn.style.color = '#fff';
            closeBtn.style.border = 'none';
            closeBtn.style.borderRadius = '50%';
            closeBtn.style.width = '32px';
            closeBtn.style.height = '32px';
            closeBtn.style.fontSize = '1.2rem';
            closeBtn.style.cursor = 'pointer';
            closeBtn.onclick = function() {
                popupBg.remove();
            };

            popup.appendChild(closeBtn);
            popup.appendChild(sad);
            popup.appendChild(txt);
            popupBg.appendChild(popup);
            document.body.appendChild(popupBg);
        }

        // main loader - uses your new API folder_contentsv3
        async function loadFolderContents(courseId, parentId = -1, pushHistory = true) {
            const grid = document.getElementById('folderGrid');
            const empty = document.getElementById('emptyMsg');
            grid.innerHTML = 'Loading...';
            empty.style.display = 'none';
            renderBreadcrumb();

            try {
                const url = `https://adeswal-eng.onrender.com/api/get/folder_contentsv3?course_id=${encodeURIComponent(courseId)}&parent_id=${encodeURIComponent(parentId)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const json = await res.json();

                grid.innerHTML = '';
                const items = Array.isArray(json.data) ? json.data : [];

                if (items.length === 0) {
                    empty.style.display = 'block';
                    empty.textContent = 'No folders/files found.';
                    return;
                }

                // update breadcrumb label for current entry if pushed
                if (pushHistory && String(parentId) !== '-1') {
                    // find the folder name from items? if not available, store generic
                    historyStack.push({ courseId, parentId, label: `Folder ${parentId}` });
                    document.getElementById('backBtn').style.display = 'inline-block';
                }
                currentParent = parentId;
                renderBreadcrumb();

                items.forEach(item => {
                    // FOLDER
                    const isFolder = item.material_type === 'FOLDER' || item.type === 'FOLDER' || item.is_folder || item.folder_name || (item.Title && item.material_type==='FOLDER');
                    if (isFolder) {
                        const el = document.createElement('div');
                        el.className = 'folder-card';
                        el.onclick = () => {
                            // push readable label if available
                            const label = item.Title || item.folder_name || item.name || 'Folder';
                            historyStack.push({ courseId, parentId: item.id || item.parent_id || item.parent || -1, label });
                            loadFolderContents(courseId, item.id || item.parent_id || item.parent || -1, false);
                            document.getElementById('backBtn').style.display = 'inline-block';
                        };

                        const img = document.createElement('img');
                        img.className = 'thumb-sm';
                        img.src = item.thumbnail || 'https://cdn-icons-png.flaticon.com/512/3767/3767084.png';
                        img.onerror = function(){ this.src='https://cdn-icons-png.flaticon.com/512/3767/3767084.png'; };

                        const meta = document.createElement('div');
                        meta.className = 'meta';
                        const name = document.createElement('div'); name.className='name'; name.textContent = item.Title || item.folder_name || item.name || 'Folder';
                        const sub = document.createElement('div'); sub.className='sub'; sub.textContent = `${item.videos_count || 0} videos ‚Ä¢ ${item.files_count || 0} files`;

                        meta.appendChild(name); meta.appendChild(sub);

                        const arrow = document.createElement('div'); arrow.className='actions'; arrow.innerHTML = '<div class="small">Open</div>';

                        el.appendChild(img); el.appendChild(meta); el.appendChild(arrow);
                        grid.appendChild(el);
                        return;
                    }

                    // PDF
                    if (item.material_type === 'PDF') {
                        const el = document.createElement('div');
                        el.className = 'file-card';

                        const img = document.createElement('img');
                        img.className = 'thumb-lg';
                        img.src = item.thumbnail || 'https://cdn-icons-png.flaticon.com/512/337/337946.png';
                        img.onerror = function(){ this.src='https://cdn-icons-png.flaticon.com/512/337/337946.png'; };

                        const meta = document.createElement('div'); meta.className='meta';
                        const name = document.createElement('div'); name.className='name'; name.textContent = item.Title || item.title || item.name || 'PDF';
                        const sub = document.createElement('div'); sub.className='sub'; sub.textContent = item.date_and_time || item.event_date || '';
                        meta.appendChild(name); meta.appendChild(sub);

                        const actions = document.createElement('div'); actions.className='actions';
                        const btnPdf = document.createElement('button'); btnPdf.className='btn pdf'; btnPdf.textContent='View PDF';
                        btnPdf.onclick = (ev) => { ev.stopPropagation(); openPdfFromItem(item); };
                        actions.appendChild(btnPdf);

                        el.appendChild(img); el.appendChild(meta); el.appendChild(actions);
                        grid.appendChild(el);
                        return;
                    }

                    // IMAGE
                    if (item.material_type === 'IMAGE' || (item.thumbnail && String(item.thumbnail).toLowerCase().endsWith('.png')) ) {
                        const el = document.createElement('div'); el.className='file-card';
                        const img = document.createElement('img'); img.className='thumb-lg'; img.src = item.thumbnail || 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                        img.onerror = function(){ this.src='https://i.postimg.cc/x1M0YN5Z/sunny.jpg'; };
                        const meta = document.createElement('div'); meta.className='meta';
                        const name = document.createElement('div'); name.className='name'; name.textContent = item.Title || item.title || item.name || 'Image';
                        const sub = document.createElement('div'); sub.className='sub'; sub.textContent = item.event_date || '';
                        meta.appendChild(name); meta.appendChild(sub);
                        el.appendChild(img); el.appendChild(meta);
                        el.onclick = () => { if(item.thumbnail) window.open(item.thumbnail,'_blank'); };
                        grid.appendChild(el);
                        return;
                    }

                    // LINK
                    if (item.material_type === 'LINK' || item.file_link) {
                        const el = document.createElement('div'); el.className='file-card';
                        const img = document.createElement('img'); img.className='thumb-lg'; img.src = item.thumbnail || 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                        img.onerror = function(){ this.src='https://i.postimg.cc/x1M0YN5Z/sunny.jpg'; };
                        const meta = document.createElement('div'); meta.className='meta';
                        const name = document.createElement('div'); name.className='name'; name.textContent = item.Title || item.title || item.name || 'Link';
                        const sub = document.createElement('div'); sub.className='sub'; sub.textContent = item.event_date || '';
                        meta.appendChild(name); meta.appendChild(sub);
                        const actions = document.createElement('div'); actions.className='actions';
                        const btn = document.createElement('button'); btn.className='btn pdf'; btn.textContent='Open Link';
                        btn.onclick = (ev) => { ev.stopPropagation(); openLinkFromItem(item); };
                        actions.appendChild(btn);
                        el.appendChild(img); el.appendChild(meta); el.appendChild(actions);
                        grid.appendChild(el);
                        return;
                    }

                    // VIDEO (always redirect to video-links.html)
                    if (item.material_type === 'VIDEO' || item.video_id || item.id) {
                        const el = document.createElement('div'); el.className='file-card';
                        const img = document.createElement('img'); img.className='thumb-lg';
                        img.src = item.thumbnail || 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                        img.onerror = function(){ this.src='https://i.postimg.cc/x1M0YN5Z/sunny.jpg'; };

                        const meta = document.createElement('div'); meta.className='meta';
                        const name = document.createElement('div'); name.className='name'; name.textContent = item.Title || item.title || item.name || 'Video';
                        const sub = document.createElement('div'); sub.className='sub'; sub.textContent = `${item.duration || ''} ${item.date_and_time ? '‚Ä¢ ' + item.date_and_time : ''}`;

                        meta.appendChild(name); meta.appendChild(sub);

                        const actions = document.createElement('div'); actions.className='actions';
                        const playBtn = document.createElement('button'); playBtn.className='btn'; playBtn.textContent='‚ñ∂ Links';
                        playBtn.onclick = (ev) => {
                            ev.stopPropagation();
                            openVideoLinks(item);
                        };

                        // PDF button if pdf exists (encrypted)
                        if (item.pdf_link || item.pdf_link2) {
                            const pdfBtn = document.createElement('button'); pdfBtn.className='btn pdf'; pdfBtn.textContent='üìÑ PDF';
                            pdfBtn.onclick = (ev) => { ev.stopPropagation(); openPdfFromItem(item); };
                            actions.appendChild(pdfBtn);
                        }

                        actions.appendChild(playBtn);
                        el.appendChild(img); el.appendChild(meta); el.appendChild(actions);

                        // also let clicking whole card open links
                        el.onclick = () => openVideoLinks(item);

                        grid.appendChild(el);
                        return;
                    }

                    // DEFAULT fallback file element
                    {
                        const el = document.createElement('div'); el.className='file-card';
                        const img = document.createElement('img'); img.className='thumb-lg';
                        img.src = item.thumbnail || 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                        img.onerror = function(){ this.src='https://i.postimg.cc/x1M0YN5Z/sunny.jpg'; };
                        const meta = document.createElement('div'); meta.className='meta';
                        const name = document.createElement('div'); name.className='name'; name.textContent = item.Title || item.title || item.name || 'File';
                        const sub = document.createElement('div'); sub.className='sub'; sub.textContent = item.event_date || '';
                        meta.appendChild(name); meta.appendChild(sub);
                        el.appendChild(img); el.appendChild(meta);
                        el.onclick = () => {
                            const link = item.file_url || item.file_link;
                            if (link) {
                                const d = decryptCustom(link);
                                window.open(d || link, '_blank');
                            }
                        };
                        grid.appendChild(el);
                    }
                });

            } catch (err) {
                console.error(err);
                document.getElementById('folderGrid').innerHTML = '';
                empty.style.display = 'block';
                empty.textContent = 'Failed to load folders/files.';
            }
        }

        // open external link (decrypt if needed)
        function openLinkFromItem(item) {
            const raw = item.file_link || item.file_url;
            if (!raw) { showSadPopup("Sorry, we can't fetch this link."); return; }
            if (raw === "6JaMPbY1Wn6AVb5u6uhyiBiomWEZo4qFvj6t7Um+HV4=:ZmVkY2JhOTg3NjU0MzIxMA==") {
                showSadPopup("Sorry, we can't fetch this link.");
                return;
            }
            const url = decryptCustom(raw) || raw;
            if (url) window.open(url, '_blank');
            else showSadPopup("Sorry, we can't fetch this link.");
        }

        // PDF handler (uses decryptCustom)
        function openPdfFromItem(item) {
            // Try pdf_link first then pdf_link2
            const sentinel = "6JaMPbY1Wn6AVb5u6uhyiBiomWEZo4qFvj6t7Um+HV4=:ZmVkY2JhOTg3NjU0MzIxMA==";
            const raw = (item.pdf_link === sentinel ? '' : item.pdf_link) || (item.pdf_link2 === sentinel ? '' : item.pdf_link2) || '';
            if (!raw) { showSadPopup("Sorry, we can't fetch your notes."); return; }
            const url = decryptCustom(raw);
            if (url) window.open(url, '_blank');
            else showSadPopup("Sorry, we can't fetch your notes.");
        }

        // Build and open video-links page. Uses new API params expected by video-links.html
        function openVideoLinks(item) {
            // Prefer item.id (folder api returns id) else item.video_id
            const videoId = encodeURIComponent(item.id || item.video_id || '');
            const ytflag = encodeURIComponent(item.ytFlagWeb ?? item.ytFlag ?? 0);
            const courseParam = encodeURIComponent(currentCourseId);
            const appParam = getQueryParam('app_id') || getQueryParam('appId') || getQueryParam('appid') || '';
            let redirect = `video-links.html?course_id=${courseParam}&video_id=${videoId}&ytflag=${ytflag}&folder_wise_course=1`;
            if (appParam) redirect += `&app_id=${encodeURIComponent(appParam)}`;
            // Also include lc_app_api_url param empty as your new API showed ‚Äî not required but safe:
            redirect += `&lc_app_api_url=`;
            window.location.href = redirect;
        }

        // Back button behaviour
        document.getElementById('backBtn').onclick = function() {
            if (historyStack.length > 0) {
                // pop last and load its parentId (go up one level)
                historyStack.pop();
                const prev = historyStack.length ? historyStack[historyStack.length - 1] : null;
                if (prev) {
                    loadFolderContents(prev.courseId, prev.parentId, false);
                } else {
                    loadFolderContents(currentCourseId, -1, false);
                    this.style.display = 'none';
                }
                this.style.display = historyStack.length ? 'inline-block' : 'none';
            } else {
                // nothing in history -> load root
                loadFolderContents(currentCourseId, -1, false);
                this.style.display = 'none';
            }
        };

        // initialize on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            if (!currentCourseId) return;
            loadFolderContents(currentCourseId, currentParent || -1, false);
            // show back button if history has items
            document.getElementById('backBtn').style.display = historyStack.length ? 'inline-block' : 'none';
        });
    </script>
</body>
</html>
