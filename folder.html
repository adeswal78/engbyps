<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Course Folders & Files</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root{
            --bg1: #00c3ff;
            --bg2: #ffff1c;
            --card-start: #fffbe7;
            --card-end: #ffe0e6;
            --accent: #d7263d;
            --btn-primary: linear-gradient(90deg, #008cff 0%, #00c3ff 100%);
            --btn-cta: linear-gradient(90deg, #ff00c8 0%, #ffb347 100%);
            --muted: #6b7280;
        }

        html,body{
            height:100%;
            margin:0;
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            background: linear-gradient(120deg, var(--bg1) 0%, var(--bg2) 100%);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        .container {
            max-width: 980px;
            margin: 22px auto;
            background: rgba(255,255,255,0.12);
            border-radius: 14px;
            box-shadow: 0 8px 40px rgba(16,24,40,0.12);
            padding: 20px;
            backdrop-filter: blur(6px);
        }

        header.top {
            display:flex;
            gap:12px;
            align-items:center;
            justify-content:space-between;
            margin-bottom: 14px;
            flex-wrap:wrap;
        }

        h2 {
            margin:0;
            font-size:20px;
            font-weight:700;
            background: linear-gradient(90deg, #00ffb8, #008cff, #ff00c8);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .top-right {
            display:flex;
            gap:10px;
            align-items:center;
        }

        .back-btn {
            background: var(--btn-cta);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 8px 14px;
            font-weight:700;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        }

        #folderList {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
            margin-top: 14px;
        }

        .folder-card, .file-card {
            background: linear-gradient(135deg, var(--card-start) 0%, var(--card-end) 100%);
            border-radius: 12px;
            padding: 12px;
            display:flex;
            flex-direction:column;
            gap:10px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.06);
            cursor:pointer;
            transition: transform .16s ease, box-shadow .16s ease;
        }

        .folder-card:hover, .file-card:hover { transform: translateY(-6px); box-shadow: 0 18px 36px rgba(0,0,0,0.12); }

        /* video/file layout */
        .file-top {
            display:flex;
            gap:12px;
            align-items:flex-start;
        }

        /* larger video thumbnail */
        .video-thumb {
            width: 220px;
            height: 124px;
            object-fit: cover;
            border-radius: 10px;
            flex-shrink: 0;
            background: #f3f4f6;
            border: 1px solid rgba(0,0,0,0.04);
        }

        .meta {
            display:flex;
            flex-direction:column;
            gap:6px;
            flex:1;
            min-width: 0;
        }

        .title {
            font-weight:700;
            color: var(--accent);
            font-size: 16px;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
        }

        .desc {
            color: var(--muted);
            font-size: 13px;
            display:inline-block;
            max-width: 100%;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
        }

        .meta-bottom {
            display:flex;
            gap:8px;
            align-items:center;
            flex-wrap:wrap;
        }

        .badge {
            background: rgba(255,255,255,0.9);
            padding:6px 8px;
            border-radius:8px;
            font-weight:700;
            font-size:12px;
            border:1px solid rgba(0,0,0,0.04);
        }

        .actions-row {
            display:flex;
            gap:8px;
            align-items:center;
            margin-top:6px;
        }

        .btn {
            padding:8px 12px;
            border-radius:10px;
            border:none;
            font-weight:700;
            cursor:pointer;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        .btn-links {
            background: var(--btn-primary);
            color:#fff;
        }

        .btn-pdf {
            background: #fff;
            color:#111;
            border:1px solid rgba(0,0,0,0.06);
        }

        .thumb-small {
            width:36px;height:36px;border-radius:8px;object-fit:cover;background:#fff;border:1px solid rgba(0,0,0,0.06);
        }

        .file-bottom {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:8px;
        }

        .file-name { font-weight:700; color:#111; font-size:15px; }

        .empty {
            padding:24px;
            text-align:center;
            font-weight:700;
            color:#fff;
            text-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }

        /* MODALS */
        .modal-bg {
            position:fixed;
            inset:0;
            background: rgba(0,0,0,0.6);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index:10000;
            padding:20px;
        }

        .modal {
            width:100%;
            max-width:1000px;
            background:#fff;
            border-radius:12px;
            overflow:hidden;
            box-shadow:0 8px 40px rgba(0,0,0,0.4);
        }

        .modal .modal-header {
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:10px 14px;
            background:linear-gradient(90deg,#f3f4f6,#fff);
            border-bottom:1px solid rgba(0,0,0,0.06);
        }

        .modal .modal-body {
            padding:0;
        }

        .close-modal {
            background:#d7263d;
            color:#fff;
            border:none;
            width:36px;
            height:36px;
            border-radius:8px;
            cursor:pointer;
            font-weight:700;
        }

        iframe.pdf-frame { width:100%; height:75vh; border:0; display:block; }

        @media(max-width:800px){
            .file-top { flex-direction:column; align-items:stretch; }
            .video-thumb { width:100%; height:160px; }
            .modal { max-width: 95vw; }
        }
    </style>

    <!-- Video.js CSS -->
    <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet" />
</head>
<body>
    <div class="container">
        <header class="top">
            <h2>Course Folders & Files</h2>
            <div class="top-right">
                <button id="backBtn" class="back-btn" style="display:none">← Back</button>
            </div>
        </header>

        <div id="folderList">Loading...</div>
        <div id="empty" class="empty" style="display:none">No folders/files found.</div>
    </div>

    <!-- Video Modal -->
    <div id="playerModal" style="display:none" class="modal-bg" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true">
            <div class="modal-header">
                <div id="playerTitle" style="font-weight:700;color:#111">Video</div>
                <button id="closePlayer" class="close-modal">×</button>
            </div>
            <div class="modal-body">
                <video id="player" class="video-js vjs-default-skin" controls preload="auto" width="100%" height="420">
                    <!-- source will be set dynamically -->
                </video>
            </div>
        </div>
    </div>

    <!-- PDF Modal -->
    <div id="pdfModal" style="display:none" class="modal-bg" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true">
            <div class="modal-header">
                <div id="pdfTitle" style="font-weight:700;color:#111">PDF</div>
                <button id="closePdf" class="close-modal">×</button>
            </div>
            <div class="modal-body">
                <iframe id="pdfFrame" class="pdf-frame" src=""></iframe>
            </div>
        </div>
    </div>

    <!-- CryptoJS for decrypt (existing logic retained) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <!-- Video.js -->
    <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>

    <script>
        /* ---------- helper utils ---------- */
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        // Keep existing decryption logic unchanged (uses same key/iv as your code)
        function decryptCustom(enc) {
            if (!enc) return "";
            try {
                const b64 = enc.split(':')[0];
                const key = CryptoJS.enc.Utf8.parse('638udh3829162018');
                const iv = CryptoJS.enc.Utf8.parse('fedcba9876543210');
                const encrypted = CryptoJS.enc.Base64.parse(b64);
                const decrypted = CryptoJS.AES.decrypt({ ciphertext: encrypted }, key, {
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });
                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                return "";
            }
        }

        // recursively search object for first string containing '.m3u8'
        function findFirstM3U8(obj) {
            if (!obj) return null;
            if (typeof obj === 'string') {
                if (obj.indexOf('.m3u8') !== -1) return obj;
                return null;
            }
            if (Array.isArray(obj)) {
                for (const it of obj) {
                    const found = findFirstM3U8(it);
                    if (found) return found;
                }
                return null;
            }
            if (typeof obj === 'object') {
                for (const k in obj) {
                    try {
                        const found = findFirstM3U8(obj[k]);
                        if (found) return found;
                    } catch(e){}
                }
            }
            return null;
        }

        // try decrypting common encrypted-looking strings (colon + base64)
        function tryDecryptCandidates(val) {
            if (!val) return null;
            // if it's obviously encrypted (contains ':' and '=')
            if (String(val).includes(':') && String(val).includes('=')) {
                const dec = decryptCustom(val);
                if (dec) return dec;
            }
            return null;
        }

        // deep-scan JSON and decrypted variants for an m3u8
        function extractM3U8FromJson(json) {
            // 1. direct search
            let found = findFirstM3U8(json);
            if (found) return found;

            // 2. try decrypting string fields and search their parsed result
            function deepScan(o) {
                if (!o) return null;
                if (typeof o === 'string') {
                    const dec = tryDecryptCandidates(o);
                    if (dec) {
                        if (dec.indexOf('.m3u8') !== -1) return dec;
                        // maybe dec is JSON
                        try {
                            const parsed = JSON.parse(dec);
                            const f = findFirstM3U8(parsed);
                            if (f) return f;
                        } catch(e){}
                    }
                    return null;
                }
                if (Array.isArray(o)) {
                    for (const it of o) {
                        const r = deepScan(it);
                        if (r) return r;
                    }
                    return null;
                }
                if (typeof o === 'object') {
                    for (const k in o) {
                        const r = deepScan(o[k]);
                        if (r) return r;
                    }
                }
                return null;
            }
            return deepScan(json);
        }

        /* ---------- UI state ---------- */
        let historyStack = [];
        let playerInstance = null;

        /* ---------- Core: load folder contents ---------- */
        async function loadFolderContents(courseId, parentId = -1, pushHistory = true) {
            const folderList = document.getElementById('folderList');
            const empty = document.getElementById('empty');
            folderList.innerHTML = 'Loading...';
            empty.style.display = 'none';
            try {
                const url = `https://adeswal-eng.onrender.com/api/get/folder_contentsv3?course_id=${encodeURIComponent(courseId)}&parent_id=${encodeURIComponent(parentId)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();

                folderList.innerHTML = '';

                const items = Array.isArray(json.data) ? json.data : (Array.isArray(json) ? json : []);
                if (items.length === 0) {
                    folderList.textContent = '';
                    empty.style.display = 'block';
                    empty.textContent = 'No folders/files found.';
                    return;
                }

                items.forEach(item => {
                    // FOLDER detection
                    if (
                        item.material_type === 'FOLDER' ||
                        item.type === 'FOLDER' ||
                        item.is_folder ||
                        item.folder_name ||
                        (item.Title && item.material_type === 'FOLDER')
                    ) {
                        const card = document.createElement('div');
                        card.className = 'folder-card';

                        const meta = document.createElement('div');
                        meta.style.display = 'flex';
                        meta.style.gap = '12px';
                        meta.style.alignItems = 'center';

                        const thumb = document.createElement('img');
                        thumb.className = 'thumb-small';
                        thumb.src = item.thumbnail || 'https://cdn-icons-png.flaticon.com/512/3767/3767084.png';
                        thumb.onerror = function() { this.src = 'https://cdn-icons-png.flaticon.com/512/3767/3767084.png'; };

                        const info = document.createElement('div');
                        info.style.display = 'flex';
                        info.style.flexDirection = 'column';
                        info.style.gap = '6px';

                        const name = document.createElement('div');
                        name.style.fontWeight = '700';
                        name.textContent = item.folder_name || item.Title || item.name || 'Folder';

                        const sub = document.createElement('div');
                        sub.style.color = '#6b7280';
                        sub.style.fontSize = '13px';
                        sub.textContent = `${item.videos_count || 0} videos • ${item.files_count || 0} files`;

                        info.appendChild(name);
                        info.appendChild(sub);

                        meta.appendChild(thumb);
                        meta.appendChild(info);

                        const arrow = document.createElement('div');
                        arrow.style.marginLeft = 'auto';
                        arrow.innerHTML = '<span style="font-weight:700;color:var(--accent)">Open</span>';

                        card.appendChild(meta);
                        card.appendChild(arrow);

                        card.onclick = function() {
                            if (pushHistory) historyStack.push({ courseId, parentId });
                            loadFolderContents(courseId, item.id || item.parent_id || item.parent || -1);
                            document.getElementById('backBtn').style.display = 'inline-block';
                        };

                        folderList.appendChild(card);
                        return;
                    }

                    // PDF
                    if (item.material_type === 'PDF' || item.pdf_link || item.study_material_link || item.pdf_link2) {
                        const card = document.createElement('div');
                        card.className = 'file-card';

                        const top = document.createElement('div');
                        top.className = 'file-top';

                        const thumb = document.createElement('img');
                        thumb.className = 'video-thumb';
                        thumb.src = item.thumbnail || 'https://cdn-icons-png.flaticon.com/512/337/337946.png';
                        thumb.onerror = function() { this.src = 'https://cdn-icons-png.flaticon.com/512/337/337946.png'; };

                        const meta = document.createElement('div');
                        meta.className = 'meta';

                        const name = document.createElement('div');
                        name.className = 'title';
                        name.textContent = item.Title || item.title || item.name || 'PDF';

                        const desc = document.createElement('div');
                        desc.className = 'desc';
                        desc.textContent = item.date_and_time || item.event_date || '';

                        const bottomMeta = document.createElement('div');
                        bottomMeta.className = 'meta-bottom';
                        const badge = document.createElement('div');
                        badge.className = 'badge';
                        badge.textContent = 'PDF';
                        bottomMeta.appendChild(badge);

                        meta.appendChild(name);
                        meta.appendChild(desc);
                        meta.appendChild(bottomMeta);

                        top.appendChild(thumb);
                        top.appendChild(meta);

                        const actions = document.createElement('div');
                        actions.className = 'actions-row';

                        const btnPdf = document.createElement('button');
                        btnPdf.className = 'btn btn-pdf';
                        btnPdf.textContent = 'Open PDF';
                        btnPdf.onclick = function(e) {
                            e.stopPropagation();
                            openPdfFromItem(item);
                        };

                        actions.appendChild(btnPdf);

                        card.appendChild(top);
                        card.appendChild(actions);

                        folderList.appendChild(card);
                        return;
                    }

                    // IMAGE
                    if (item.material_type === 'IMAGE' || (item.thumbnail && String(item.thumbnail).toLowerCase().endsWith('.png'))) {
                        const card = document.createElement('div');
                        card.className = 'file-card';

                        const img = document.createElement('img');
                        img.className = 'video-thumb';
                        img.src = item.thumbnail ? item.thumbnail : 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                        img.onerror = function() { this.src = 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg'; };

                        const name = document.createElement('div');
                        name.className = 'title';
                        name.textContent = item.Title || item.title || item.name || 'Image';

                        card.appendChild(img);
                        card.appendChild(name);

                        card.onclick = function() {
                            if (item.thumbnail) window.open(item.thumbnail, '_blank');
                        };

                        folderList.appendChild(card);
                        return;
                    }

                    // LINK
                    if (item.material_type === 'LINK' || item.file_link) {
                        const card = document.createElement('div');
                        card.className = 'file-card';

                        const top = document.createElement('div');
                        top.className = 'file-top';

                        const thumb = document.createElement('img');
                        thumb.className = 'video-thumb';
                        thumb.src = item.thumbnail ? item.thumbnail : 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                        thumb.onerror = function() { this.src = 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg'; };

                        const meta = document.createElement('div');
                        meta.className = 'meta';

                        const name = document.createElement('div');
                        name.className = 'title';
                        name.textContent = item.Title || item.title || item.name || 'Link';

                        const desc = document.createElement('div');
                        desc.className = 'desc';
                        desc.textContent = item.event_date || '';

                        meta.appendChild(name);
                        meta.appendChild(desc);

                        top.appendChild(thumb);
                        top.appendChild(meta);

                        const actions = document.createElement('div');
                        actions.className = 'actions-row';

                        const btnOpen = document.createElement('button');
                        btnOpen.className = 'btn btn-links';
                        btnOpen.textContent = 'Open Link';
                        btnOpen.onclick = function(e) {
                            e.stopPropagation();
                            openLinkFromItem(item);
                        };

                        actions.appendChild(btnOpen);

                        card.appendChild(top);
                        card.appendChild(actions);

                        folderList.appendChild(card);
                        return;
                    }

                    // VIDEO — show bigger thumb + Play & PDF buttons
                    if (item.material_type === 'VIDEO' || item.video_id || item.id) {
                        const card = document.createElement('div');
                        card.className = 'file-card';

                        const top = document.createElement('div');
                        top.className = 'file-top';

                        const thumb = document.createElement('img');
                        thumb.className = 'video-thumb';
                        thumb.src = item.thumbnail ? item.thumbnail : 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                        thumb.onerror = function() { this.src = 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg'; };

                        const meta = document.createElement('div');
                        meta.className = 'meta';

                        const name = document.createElement('div');
                        name.className = 'title';
                        name.textContent = item.Title || item.title || item.name || 'Video';

                        const desc = document.createElement('div');
                        desc.className = 'desc';
                        desc.textContent = `${item.duration || ''} ${item.date_and_time ? '• ' + item.date_and_time : ''}`;

                        const bottomMeta = document.createElement('div');
                        bottomMeta.className = 'meta-bottom';

                        const badge = document.createElement('div');
                        badge.className = 'badge';
                        badge.textContent = 'Video';

                        const videosCount = document.createElement('div');
                        videosCount.style.color = '#6b7280';
                        videosCount.style.fontSize = '13px';
                        videosCount.textContent = item.free_flag ? (String(item.free_flag)==='1' ? 'Free' : '') : '';

                        bottomMeta.appendChild(badge);
                        if (videosCount.textContent) bottomMeta.appendChild(videosCount);

                        meta.appendChild(name);
                        meta.appendChild(desc);
                        meta.appendChild(bottomMeta);

                        top.appendChild(thumb);
                        top.appendChild(meta);

                        const actions = document.createElement('div');
                        actions.className = 'actions-row';

                        // Play button -> try to play inline
                        const btnPlay = document.createElement('button');
                        btnPlay.className = 'btn btn-links';
                        btnPlay.textContent = 'Play';
                        btnPlay.onclick = function(e) {
                            e.stopPropagation();
                            playVideoFromItem(item);
                        };
                        actions.appendChild(btnPlay);

                        // PDF button (if any pdf link present)
                        if (item.pdf_link || item.pdf_link2 || item.study_material_link || item.file_link || item.file_url) {
                            const btnPdf = document.createElement('button');
                            btnPdf.className = 'btn btn-pdf';
                            btnPdf.textContent = 'PDF';
                            btnPdf.onclick = function(e) {
                                e.stopPropagation();
                                openPdfFromItem(item);
                            };
                            actions.appendChild(btnPdf);
                        }

                        card.appendChild(top);
                        card.appendChild(actions);

                        // also allow clicking entire card to play
                        card.onclick = function() {
                            playVideoFromItem(item);
                        };

                        folderList.appendChild(card);
                        return;
                    }

                    // DEFAULT FILE
                    {
                        const card = document.createElement('div');
                        card.className = 'file-card';

                        const thumb = document.createElement('img');
                        thumb.className = 'video-thumb';
                        thumb.src = item.thumbnail ? item.thumbnail : 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                        thumb.onerror = function() { this.src = 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg'; };

                        const name = document.createElement('div');
                        name.className = 'title';
                        name.textContent = item.Title || item.title || item.name || 'File';

                        const desc = document.createElement('div');
                        desc.className = 'desc';
                        desc.textContent = item.event_date || '';

                        card.appendChild(thumb);
                        card.appendChild(name);
                        card.appendChild(desc);

                        card.onclick = function() {
                            if (item.file_url || item.file_link) {
                                const link = item.file_url || item.file_link;
                                const d = decryptCustom(link);
                                window.open(d || link, '_blank');
                            }
                        };

                        folderList.appendChild(card);
                    }
                });

            } catch (err) {
                console.error(err);
                folderList.innerHTML = 'Failed to load folders/files.';
                empty.style.display = 'block';
                empty.textContent = 'Failed to load folders/files.';
            }
        }

        /* ---------- Video play flow ---------- */
        // get a usable video URL (m3u8 or mp4) from item
        async function resolveVideoUrlFromItem(item) {
            // try direct candidates
            const candidates = [
                item.download_link, item.download_links, item.file_url, item.file_link,
                item.video_url, item.video_source, item.path, item.path_enc
            ];

            // flatten arrays/objects
            const flat = [];
            for (const c of candidates) {
                if (!c) continue;
                if (Array.isArray(c)) {
                    c.forEach(x => flat.push(x));
                } else {
                    flat.push(c);
                }
            }

            // 1) check direct strings (and decrypted variants)
            for (const c of flat) {
                try {
                    if (typeof c === 'string') {
                        const dec = tryDecryptCandidates(c) || c;
                        if (typeof dec === 'string' && dec.indexOf('.m3u8') !== -1) return dec;
                    } else if (typeof c === 'object') {
                        const f = findFirstM3U8(c);
                        if (f) return f;
                    }
                } catch(e){}
            }

            // 2) fallback: call fetchVideoDetailsById via proxy to get more info
            try {
                const courseParam = encodeURIComponent(getQueryParam('courseid') || getQueryParam('course_id') || getQueryParam('courseId') || item.course_id || item.courseId || '');
                const vidParam = encodeURIComponent(item.id || item.video_id || item.videoId || item.asset_id || '');
                if (!vidParam) return null;
                const apiUrl = `https://adeswal-eng.onrender.com/api/get/fetchVideoDetailsById?course_id=${courseParam}&video_id=${vidParam}&ytflag=0&folder_wise_course=1`;
                const res = await fetch(apiUrl);
                if (!res.ok) return null;
                const j = await res.json();
                const payload = j.data ? j.data : j;
                // try find direct m3u8
                let found = extractM3U8FromJson(payload);
                if (found) return found;

                // try download_links array
                if (payload.download_links && Array.isArray(payload.download_links)) {
                    for (const dl of payload.download_links) {
                        if (dl.path) {
                            const dec = tryDecryptCandidates(dl.path) || dl.path;
                            if (dec && dec.indexOf('.m3u8') !== -1) return dec;
                        }
                        if (dl.url && String(dl.url).indexOf('.m3u8') !== -1) return dl.url;
                    }
                }

                if (payload.download_link) {
                    const dec = tryDecryptCandidates(payload.download_link) || payload.download_link;
                    if (dec && dec.indexOf('.m3u8') !== -1) return dec;
                }
            } catch(e){
                console.warn("fetchVideoDetailsById failed:", e);
            }

            return null;
        }

        async function playVideoFromItem(item) {
            try {
                document.getElementById('playerTitle').textContent = item.Title || item.title || 'Video';
                const url = await resolveVideoUrlFromItem(item);
                if (!url) {
                    showSadPopup("Couldn't find playable video for this item.");
                    return;
                }

                const modal = document.getElementById('playerModal');
                modal.style.display = 'flex';
                modal.setAttribute('aria-hidden', 'false');

                if (!playerInstance) {
                    playerInstance = videojs('player', {
                        controls: true,
                        autoplay: false,
                        preload: 'auto'
                    });
                }

                try {
                    playerInstance.pause();
                    playerInstance.src({ src: url, type: url.indexOf('.m3u8') !== -1 ? 'application/x-mpegURL' : 'video/mp4' });
                    playerInstance.ready(() => {
                        playerInstance.play().catch(()=>{ /* autoplay blocked */ });
                    });
                } catch (e) {
                    console.error("player set src error", e);
                    showSadPopup("Unable to start playback.");
                }
            } catch (err) {
                console.error(err);
                showSadPopup("Error while trying to play video.");
            }
        }

        // close player modal
        document.addEventListener('DOMContentLoaded', function(){
            document.getElementById('closePlayer').onclick = function() {
                const modal = document.getElementById('playerModal');
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                try {
                    if (playerInstance) {
                        playerInstance.pause();
                        playerInstance.src('');
                    }
                } catch(e){}
            };

            document.getElementById('closePdf').onclick = function() {
                const modal = document.getElementById('pdfModal');
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                document.getElementById('pdfFrame').src = '';
            };
        });

        /* ---------- Link & PDF open flow ---------- */
        function openLinkFromItem(item) {
            const raw = item.file_link || item.file_url;
            if (!raw) { showSadPopup("Sorry, we can't fetch this link."); return; }
            const sentinel = "6JaMPbY1Wn6AVb5u6uhyiBiomWEZo4qFvj6t7Um+HV4=:ZmVkY2JhOTg3NjU0MzIxMA==";
            if (raw === sentinel) { showSadPopup("Sorry, we can't fetch this link."); return; }
            const url = decryptCustom(raw) || raw;
            if (url) window.open(url, '_blank');
            else showSadPopup("Sorry, we can't fetch this link.");
        }

        function openPdfFromItem(item) {
            const sentinel = "6JaMPbY1Wn6AVb5u6uhyiBiomWEZo4qFvj6t7Um+HV4=:ZmVkY2JhOTg3NjU0MzIxMA==";
            const candidates = [];
            if (item.study_material_link) candidates.push(item.study_material_link);
            if (item.pdf_link) candidates.push(item.pdf_link);
            if (item.pdf_link2) candidates.push(item.pdf_link2);
            if (item.file_link) candidates.push(item.file_link);
            if (item.file_url) candidates.push(item.file_url);

            const filtered = candidates.filter(c => c && String(c) !== sentinel);
            if (filtered.length === 0) {
                showSadPopup("Sorry, we can't fetch your notes.");
                return;
            }

            for (let raw of filtered) {
                const dec = decryptCustom(raw);
                const use = dec || raw;
                if (!use) continue;
                if (String(use) === sentinel) continue;
                try {
                    const pdfFrame = document.getElementById('pdfFrame');
                    if (use.indexOf('viewer.html') !== -1 || use.toLowerCase().endsWith('.pdf')) {
                        pdfFrame.src = use;
                    } else {
                        pdfFrame.src = `https://adeswal-eng.onrender.com/pdfjs/web/viewer.html?file=${encodeURIComponent(use)}`;
                    }
                    document.getElementById('pdfTitle').textContent = item.Title || item.title || 'PDF';
                    const modal = document.getElementById('pdfModal');
                    modal.style.display = 'flex';
                    modal.setAttribute('aria-hidden', 'false');
                    return;
                } catch(e){
                    window.open(use, '_blank');
                    return;
                }
            }

            showSadPopup("Sorry, we can't fetch your notes.");
        }

        // Sad popup (unchanged)
        function showSadPopup(msg) {
            let old = document.getElementById('sadPopupBg');
            if (old) old.remove();
            const popupBg = document.createElement('div');
            popupBg.id = 'sadPopupBg';
            popupBg.style.position = 'fixed';
            popupBg.style.top = 0;
            popupBg.style.left = 0;
            popupBg.style.right = 0;
            popupBg.style.bottom = 0;
            popupBg.style.background = 'rgba(0,0,0,0.45)';
            popupBg.style.zIndex = 9999;
            popupBg.style.display = 'flex';
            popupBg.style.alignItems = 'center';
            popupBg.style.justifyContent = 'center';

            const popup = document.createElement('div');
            popup.style.background = '#fffbe7';
            popup.style.borderRadius = '18px';
            popup.style.boxShadow = '0 8px 32px #d7263d44';
            popup.style.padding = '32px 28px 22px 28px';
            popup.style.minWidth = '320px';
            popup.style.maxWidth = '95vw';
            popup.style.border = '3px solid #d7263d';
            popup.style.position = 'relative';
            popup.style.textAlign = 'center';

            const sad = document.createElement('div');
            sad.className = 'sad-icon';
            sad.style.fontSize = '3rem';
            sad.style.marginBottom = '18px';
            sad.textContent = '😢';

            const txt = document.createElement('div');
            txt.className = 'sad-text';
            txt.style.fontSize = '1.15rem';
            txt.style.color = '#d7263d';
            txt.textContent = msg;

            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-sad-popup';
            closeBtn.textContent = '×';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '10px';
            closeBtn.style.right = '18px';
            closeBtn.style.background = '#d7263d';
            closeBtn.style.color = '#fff';
            closeBtn.style.border = 'none';
            closeBtn.style.borderRadius = '50%';
            closeBtn.style.width = '32px';
            closeBtn.style.height = '32px';
            closeBtn.style.fontSize = '1.2rem';
            closeBtn.style.cursor = 'pointer';
            closeBtn.onclick = function() {
                popupBg.remove();
            };

            popup.appendChild(closeBtn);
            popup.appendChild(sad);
            popup.appendChild(txt);
            popupBg.appendChild(popup);
            document.body.appendChild(popupBg);
        }

        // init
        document.addEventListener('DOMContentLoaded', function() {
            const courseId = getQueryParam('courseid') || getQueryParam('course_id') || getQueryParam('courseId');
            if (!courseId) {
                document.getElementById('folderList').textContent = '';
                document.getElementById('empty').style.display = 'block';
                document.getElementById('empty').textContent = 'Course ID missing in URL.';
                return;
            }
            loadFolderContents(courseId, -1);

            document.getElementById('backBtn').onclick = function() {
                if (historyStack.length > 0) {
                    const prev = historyStack.pop();
                    loadFolderContents(prev.courseId, prev.parentId, false);
                    if (historyStack.length === 0) this.style.display = 'none';
                }
            };
        });
    </script>
</body>
</html>
