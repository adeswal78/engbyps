<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Course Folders & Files</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: linear-gradient(120deg, #00c3ff 0%, #ffff1c 100%);
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 2rem auto;
            background: rgba(255, 255, 255, 0.13);
            border-radius: 18px;
            box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.18);
            padding: 2rem 1rem;
        }
        
        h2 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(90deg, #00ffb8, #008cff, #ff00c8);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            font-weight: 700;
        }
        
        #folderList {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .folder-card {
            background: linear-gradient(90deg, #fffbe7 0%, #ffe0e6 100%);
            border-radius: 12px;
            padding: 0.7rem 1rem;
            box-shadow: 0 2px 12px 0 #d7263d22;
            border: 2px solid #ffb347;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            cursor: pointer;
            font-size: 1.08rem;
            font-weight: 600;
            color: #d7263d;
            min-height: 48px;
            transition: background 0.18s, transform 0.18s, border 0.18s;
        }
        
        .folder-card:hover {
            background: #ffb347;
            color: #fff;
            border-color: #d7263d;
            transform: scale(1.04);
        }
        
        .file-card {
            background: rgba(255, 255, 255, 0.10);
            border-radius: 10px;
            padding: 0.7rem 1rem;
            box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 0.7rem;
            cursor: pointer;
            font-size: 1.02rem;
            font-weight: 500;
            color: #d7263d;
            min-height: 48px;
            transition: background 0.18s, transform 0.18s;
        }
        
        .file-card:hover {
            background: #008cff;
            color: #fff;
            transform: scale(1.04);
        }
        
        .back-btn {
            margin-bottom: 1rem;
            background: #ff00c8;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1.2rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.18s;
        }
        
        .back-btn:hover {
            background: #008cff;
        }
        
        .folder-thumb {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: 7px;
            margin-right: 8px;
            background: #fff;
            border: 1.2px solid #d7263d33;
        }
        
        .thumb {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: 7px;
            margin-right: 8px;
            background: #fff;
            border: 1.2px solid #d7263d33;
        }
        
        .folder-arrow {
            margin-left: auto;
            width: 18px;
            height: 18px;
            display: inline-block;
            background: url('data:image/svg+xml;utf8,<svg fill=\"%23d7263d\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z\"/></svg>') no-repeat center center;
            background-size: 18px 18px;
        }
        /* Sad Popup Styles */
        
        #sadPopupBg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #sadPopup {
            background: #fffbe7;
            border-radius: 18px;
            box-shadow: 0 8px 32px #d7263d44;
            padding: 32px 28px 22px 28px;
            min-width: 320px;
            max-width: 95vw;
            border: 3px solid #d7263d;
            position: relative;
            text-align: center;
        }
        
        #sadPopup .sad-icon {
            font-size: 3rem;
            margin-bottom: 18px;
        }
        
        #sadPopup .sad-text {
            font-size: 1.15rem;
            color: #d7263d;
        }
        
        #sadPopup .close-sad-popup {
            position: absolute;
            top: 10px;
            right: 18px;
            background: #d7263d;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.2rem;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>Course Folders & Files</h2>
        <button class="back-btn" id="backBtn" style="display:none">Back</button>
        <div id="folderList">Loading...</div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script>
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }
        // Decrypt function matching your Python logic
        function decryptCustom(enc) {
            if (!enc) return "";
            try {
                const b64 = enc.split(':')[0];
                const key = CryptoJS.enc.Utf8.parse('638udh3829162018');
                const iv = CryptoJS.enc.Utf8.parse('fedcba9876543210');
                const encrypted = CryptoJS.enc.Base64.parse(b64);
                const decrypted = CryptoJS.AES.decrypt({
                    ciphertext: encrypted
                }, key, {
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });
                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                return "";
            }
        }
        let historyStack = [];

        function loadFolderContents(courseId, parentId = -1, pushHistory = true) {
            const appId = getQueryParam("app_id");
            const folderList = document.getElementById('folderList');
            folderList.innerHTML = 'Loading...';
            fetch(`https://adeswal-eng.onrender.com/api/get/folder_contentsv3?course_id=${courseId}&parent_id=${parentId}`)
                .then(res => res.json())
                .then(json => {
                    folderList.innerHTML = '';
                    if (json.data && Array.isArray(json.data) && json.data.length > 0) {
                        json.data.forEach(item => {
                            // FOLDER
                            if (
                                item.material_type === 'FOLDER' ||
                                item.type === 'FOLDER' ||
                                item.is_folder ||
                                item.folder_name
                            ) {
                                const card = document.createElement('div');
                                card.className = 'folder-card';
                                // Folder thumb (if available), else default icon
                                if (item.thumbnail) {
                                    const thumb = document.createElement('img');
                                    thumb.className = 'thumb';
                                    thumb.src = item.thumbnail;
                                    thumb.onerror = function() {
                                        this.src = 'https://cdn-icons-png.flaticon.com/512/3767/3767084.png';
                                    };
                                    card.appendChild(thumb);
                                } else {
                                    const thumb = document.createElement('img');
                                    thumb.className = 'thumb';
                                    thumb.src = 'https://cdn-icons-png.flaticon.com/512/3767/3767084.png';
                                    card.appendChild(thumb);
                                }
                                // Folder name
                                const name = document.createElement('span');
                                name.textContent = item.folder_name || item.name || item.title || item.Title || 'Folder';
                                card.appendChild(name);
                                // Arrow icon
                                const arrow = document.createElement('span');
                                arrow.className = 'folder-arrow';
                                card.appendChild(arrow);
                                card.onclick = function() {
                                    if (pushHistory) historyStack.push({
                                        courseId,
                                        parentId
                                    });
                                    loadFolderContents(courseId, item.id || item.parent_id);
                                    document.getElementById('backBtn').style.display = 'inline-block';
                                };
                                folderList.appendChild(card);
                            }
                            // PDF
                            else if (item.material_type === 'PDF') {
                                const card = document.createElement('div');
                                card.className = 'file-card';
                                if (item.thumbnail) {
                                    const thumb = document.createElement('img');
                                    thumb.className = 'thumb';
                                    thumb.src = item.thumbnail;
                                    thumb.onerror = function() {
                                        this.src = 'https://cdn-icons-png.flaticon.com/512/337/337946.png';
                                    };
                                    card.appendChild(thumb);
                                } else {
                                    const thumb = document.createElement('img');
                                    thumb.className = 'thumb';
                                    thumb.src = 'https://cdn-icons-png.flaticon.com/512/337/337946.png';
                                    card.appendChild(thumb);
                                }
                                const name = document.createElement('span');
                                name.textContent = item.Title || item.title || item.name || 'PDF';
                                card.appendChild(name);
                                card.onclick = function() {
                                    // Dummy PDF link check
                                    if (item.pdf_link === "6JaMPbY1Wn6AVb5u6uhyiBiomWEZo4qFvj6t7Um+HV4=:ZmVkY2JhOTg3NjU0MzIxMA==" ||
                                        item.pdf_link2 === "6JaMPbY1Wn6AVb5u6uhyiBiomWEZo4qFvj6t7Um+HV4=:ZmVkY2JhOTg3NjU0MzIxMA==") {
                                        showSadPopup("Sorry, we can't fetch your notes.");
                                    } else if (item.pdf_link) {
                                        window.open(decryptCustom(item.pdf_link), '_blank');
                                    } else if (item.pdf_link2) {
                                        window.open(decryptCustom(item.pdf_link2), '_blank');
                                    } else {
                                        showSadPopup("Sorry, we can't fetch your notes.");
                                    }
                                };
                                folderList.appendChild(card);
                            }
                            // IMAGE
                            else if (item.material_type === 'IMAGE' || (item.thumbnail && item.thumbnail.endsWith('.png'))) {
                                const card = document.createElement('div');
                                card.className = 'file-card';
                                const thumb = document.createElement('img');
                                thumb.className = 'thumb';
                                thumb.src = item.thumbnail ? item.thumbnail : 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                                thumb.onerror = function() {
                                    this.src = 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                                };
                                card.appendChild(thumb);
                                const name = document.createElement('span');
                                name.textContent = item.Title || item.title || item.name || 'Image';
                                card.appendChild(name);
                                card.onclick = function() {
                                    if (item.thumbnail) window.open(item.thumbnail, '_blank');
                                };
                                folderList.appendChild(card);
                            }
                            // LINK
                            else if (item.material_type === 'LINK' || item.file_link) {
                                const card = document.createElement('div');
                                card.className = 'file-card';
                                const thumb = document.createElement('img');
                                thumb.className = 'thumb';
                                thumb.src = item.thumbnail ? item.thumbnail : 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                                thumb.onerror = function() {
                                    this.src = 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                                };
                                card.appendChild(thumb);
                                const name = document.createElement('span');
                                name.textContent = item.Title || item.title || item.name || 'Link';
                                card.appendChild(name);
                                card.onclick = function() {
                                    if (item.file_link === "6JaMPbY1Wn6AVb5u6uhyiBiomWEZo4qFvj6t7Um+HV4=:ZmVkY2JhOTg3NjU0MzIxMA==") {
                                        showSadPopup("Sorry, we can't fetch your notes.");
                                    } else if (item.file_link) {
                                        window.open(decryptCustom(item.file_link), '_blank');
                                    }
                                };
                                folderList.appendChild(card);
                            }
                            // VIDEO
                            else if (item.material_type === 'VIDEO' || item.video_id) {
                                const card = document.createElement('div');
                                card.className = 'file-card';
                                const thumb = document.createElement('img');
                                thumb.className = 'thumb';
                                thumb.src = item.thumbnail ? item.thumbnail : 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                                thumb.onerror = function() {
                                    this.src = 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                                };
                                card.appendChild(thumb);
                                const name = document.createElement('span');
                                name.textContent = item.Title || item.title || item.name || 'Video';
                                card.appendChild(name);
                                card.onclick = function() {
                                    if (item.video_id) {
                                        const vid = decryptCustom(item.video_id);
                                        if (vid) {
                                            window.open(`https://www.youtube.com/watch?v=${vid}`, '_blank');
                                        } else {
                                            showSadPopup("Sorry, we can't fetch this video.");
                                        }
                                    } else {
                                        // Open video-links.html with videoid and folder_wise_course=1
                                        const appId = getQueryParam("app_id");
                                        window.location.href = `video-links.html?app_id=${appId}&videoid=${item.id || item.video_id}&folder_wise_course=1`;
                                    }
                                };
                                folderList.appendChild(card);
                            }
                            // DEFAULT FILE
                            else {
                                const card = document.createElement('div');
                                card.className = 'file-card';
                                const thumb = document.createElement('img');
                                thumb.className = 'thumb';
                                thumb.src = item.thumbnail ? item.thumbnail : 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                                thumb.onerror = function() {
                                    this.src = 'https://i.postimg.cc/x1M0YN5Z/sunny.jpg';
                                };
                                card.appendChild(thumb);
                                const name = document.createElement('span');
                                name.textContent = item.Title || item.title || item.name || 'File';
                                card.appendChild(name);
                                card.onclick = function() {
                                    if (item.file_url || item.file_link) window.open(item.file_url || item.file_link, '_blank');
                                };
                                folderList.appendChild(card);
                            }
                        });
                    } else {
                        folderList.textContent = 'No folders/files found.';
                    }
                });
        }
        document.addEventListener('DOMContentLoaded', function() {
            const courseId = getQueryParam('courseid') || getQueryParam('course_id');
            loadFolderContents(courseId, -1);
            document.getElementById('backBtn').onclick = function() {
                if (historyStack.length > 0) {
                    const prev = historyStack.pop();
                    loadFolderContents(prev.courseId, prev.parentId, false);
                    if (historyStack.length === 0) this.style.display = 'none';
                }
            };
        });

        function showSadPopup(msg) {
            let old = document.getElementById('sadPopupBg');
            if (old) old.remove();
            const popupBg = document.createElement('div');
            popupBg.id = 'sadPopupBg';
            popupBg.style.position = 'fixed';
            popupBg.style.top = 0;
            popupBg.style.left = 0;
            popupBg.style.right = 0;
            popupBg.style.bottom = 0;
            popupBg.style.background = 'rgba(0,0,0,0.45)';
            popupBg.style.zIndex = 9999;
            popupBg.style.display = 'flex';
            popupBg.style.alignItems = 'center';
            popupBg.style.justifyContent = 'center';

            const popup = document.createElement('div');
            popup.style.background = '#fffbe7';
            popup.style.borderRadius = '18px';
            popup.style.boxShadow = '0 8px 32px #d7263d44';
            popup.style.padding = '32px 28px 22px 28px';
            popup.style.minWidth = '320px';
            popup.style.maxWidth = '95vw';
            popup.style.border = '3px solid #d7263d';
            popup.style.position = 'relative';
            popup.style.textAlign = 'center';

            const sad = document.createElement('div');
            sad.className = 'sad-icon';
            sad.style.fontSize = '3rem';
            sad.style.marginBottom = '18px';
            sad.textContent = '😢';

            const txt = document.createElement('div');
            txt.className = 'sad-text';
            txt.style.fontSize = '1.15rem';
            txt.style.color = '#d7263d';
            txt.textContent = msg;

            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-sad-popup';
            closeBtn.textContent = '×';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '10px';
            closeBtn.style.right = '18px';
            closeBtn.style.background = '#d7263d';
            closeBtn.style.color = '#fff';
            closeBtn.style.border = 'none';
            closeBtn.style.borderRadius = '50%';
            closeBtn.style.width = '32px';
            closeBtn.style.height = '32px';
            closeBtn.style.fontSize = '1.2rem';
            closeBtn.style.cursor = 'pointer';
            closeBtn.onclick = function() {
                popupBg.remove();
            };

            popup.appendChild(closeBtn);
            popup.appendChild(sad);
            popup.appendChild(txt);
            popupBg.appendChild(popup);
            document.body.appendChild(popupBg);
        }
    </script>
</body>

</html>